name: Docker Image CI

on:
  push:
    branches: [ "*" ]
  pull_request:
    branches: [ "main" ]

jobs:

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build the Docker image
        run: docker build . --file Dockerfile --tag my-image-name:$(date +%s)
      - name: Install package
        run: pip install -r requirements.txt
      - name: Test the code
        run: python manage.py test

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag my-image-name:$(date +%s)

  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (not strictly required for SSH-only deploy)
        uses: actions/checkout@v4

      - name: Install SSH key
        run: |
          echo "${{ secrets.EC2_KEY }}" > key.pem
          chmod 600 key.pem
          mkdir -p ~/.ssh
          # Avoid host key prompt on first connect
          printf "Host *\n\tStrictHostKeyChecking no\n" > ~/.ssh/config

      - name: Deploy on EC2
        run: |
          ssh -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOSSH'
          set -e

          # Ensure the app directory exists; if not, clone it
          if [ ! -d "${APP_DIR}" ]; then
            git clone https://github.com/${GITHUB_REPOSITORY}.git "${APP_DIR}"
          fi

          cd "${APP_DIR}"

          # Fetch the latest code from main
          git fetch origin main
          git reset --hard origin/main

          # Build & run containers (uses .env stored on the server)
          sudo docker compose build
          sudo docker compose up -d --remove-orphans

          # Show container status
          sudo docker compose ps
          EOSSH
